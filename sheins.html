<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fotos Shein + Cantidad</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #preview { margin: 20px; }
        #image { max-width: 100%; height: auto; }
        #count, #totals { font-size: 18px; }
        button, select { margin: 10px; padding: 10px 20px; }
        #signature { text-align: right; margin: 20px; font-style: italic; }
        #shareLink { margin: 10px; word-break: break-all; }
        #fallbackText { display: none; margin: 20px; }
        #viewerSection { display: none; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="uploaderSection">
        <h1>Fotos Shein + Cantidad</h1>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.json">
        <select id="familyFilter" disabled>
            <option value="all">Todas las familias</option>
        </select>
        <button onclick="generatePreview()">Generar</button>
        <button onclick="shareSummary()" disabled id="shareButton">Compartir Resumen</button>
        <div id="shareLink"></div>
        <div id="preview">
            <img id="image" src="" alt="Artículo">
            <p id="count"></p>
            <p id="totals"></p>
            <button id="prevButton" onclick="prevImage()" disabled>Anterior</button>
            <button id="nextButton" onclick="nextImage()" disabled>Siguiente</button>
        </div>
        <div id="signature">Leonardo Machado</div>
        <textarea id="fallbackText" rows="5" cols="50" readonly></textarea>
    </div>

    <div id="viewerSection">
        <h1>Visor de Resumen</h1>
        <select id="viewerFamilyFilter" disabled>
            <option value="all">Todas las familias</option>
        </select>
        <div id="viewerPreview">
            <img id="viewerImage" src="" alt="Artículo">
            <p id="viewerCount"></p>
            <p id="viewerTotals"></p>
            <button id="viewerPrevButton" onclick="viewerPrevImage()" disabled>Anterior</button>
            <button id="viewerNextButton" onclick="viewerNextImage()" disabled>Siguiente</button>
        </div>
        <div id="viewerSignature">Leonardo Machado</div>
    </div>

    <script>
        let data = [];
        let filteredData = [];
        let currentIndex = 0;
        let families = new Set();

        // Viewer variables
        let viewerData = [];
        let viewerFilteredData = [];
        let viewerCurrentIndex = 0;
        let viewerFamilies = new Set();

        async function generatePreview() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return alert('Por favor, selecciona un archivo XLS o JSON.');

            const reader = new FileReader();
            reader.onload = async function(e) {
                const fileType = file.name.split('.').pop().toLowerCase();
                if (fileType === 'json') {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        data = jsonData.data || [];
                        families = new Set(jsonData.families || []);
                    } catch (error) {
                        alert('Error al leer el archivo JSON.');
                        return;
                    }
                } else {
                    const binary = e.target.result;
                    const workbook = XLSX.read(binary, { type: 'binary' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                }

                if (data.length < 1 || data[0].length < 3) {
                    alert('El archivo debe tener al menos tres columnas: URLs, cantidades y familias.');
                    return;
                }

                data = data.filter(row => row[0] && !isNaN(row[1]) && row[2]);
                if (data.length === 0) {
                    alert('No se encontraron datos válidos en el archivo.');
                    return;
                }

                families = new Set(data.map(row => row[2]));
                const familyFilter = document.getElementById('familyFilter');
                familyFilter.innerHTML = '<option value="all">Todas las familias</option>';
                families.forEach(family => {
                    const option = document.createElement('option');
                    option.value = family;
                    option.textContent = family;
                    familyFilter.appendChild(option);
                });
                familyFilter.disabled = false;
                familyFilter.onchange = filterByFamily;

                filteredData = data;
                currentIndex = 0;
                updateImage();
                document.getElementById('shareButton').disabled = false;
            };
            if (file.name.endsWith('.json')) {
                reader.readAsText(file);
            } else {
                reader.readAsBinaryString(file);
            }
        }

        function filterByFamily() {
            const familyFilter = document.getElementById('familyFilter').value;
            filteredData = familyFilter === 'all' ? data : data.filter(row => row[2] === familyFilter);
            currentIndex = 0;
            updateImage();
        }

        function updateImage() {
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');

            if (filteredData.length === 0) {
                document.getElementById('image').src = '';
                document.getElementById('count').textContent = '';
                document.getElementById('totals').textContent = '';
                prevButton.disabled = true;
                nextButton.disabled = true;
                return;
            }

            const image = document.getElementById('image');
            const count = document.getElementById('count');
            const totals = document.getElementById('totals');
            image.src = filteredData[currentIndex][0];
            count.textContent = `Artículo ${currentIndex + 1} de ${filteredData.length} - Cantidad: ${filteredData[currentIndex][1]} - Familia: ${filteredData[currentIndex][2]}`;
            const totalModel = filteredData[currentIndex][1];
            const totalFamily = filteredData.reduce((sum, row) => sum + Number(row[1]), 0);
            totals.textContent = `Total del modelo: ${totalModel} - Total de ${filteredData[currentIndex][2]}: ${totalFamily}`;
            prevButton.disabled = currentIndex === 0;
            nextButton.disabled = currentIndex === filteredData.length - 1;
        }

        function nextImage() {
            if (currentIndex < filteredData.length - 1) {
                currentIndex++;
                updateImage();
            }
        }

        function prevImage() {
            if (currentIndex > 0) {
                currentIndex--;
                updateImage();
            }
        }

        async function shareSummary() {
            if (data.length === 0) return alert('No hay datos para compartir.');

            try {
                const summary = {
                    data: data,
                    families: Array.from(families)
                };
                const jsonString = JSON.stringify(summary);

                const response = await fetch('https://pastebin.com/api/api_post.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        'api_dev_key': 'YOUR_PASTEBIN_API_KEY', // Reemplaza con tu clave de Pastebin
                        'api_option': 'paste',
                        'api_paste_code': jsonString,
                        'api_paste_private': '1', // 1 = no listado (acceso solo con enlace)
                        'api_paste_name': 'Resumen Shein',
                        'api_paste_expire_date': '1W' // Expira en 1 semana
                    })
                });

                if (!response.ok) {
                    throw new Error('Error al subir a Pastebin');
                }

                const pasteUrl = await response.text();
                const viewerUrl = `${window.location.href.split('?')[0]}?view=${encodeURIComponent(pasteUrl)}`;

                const shareLinkDiv = document.getElementById('shareLink');
                shareLinkDiv.innerHTML = `Enlace único: <a href="${viewerUrl}" target="_blank">${viewerUrl}</a> (expira en 1 semana)`;

                // Fallback text
                const fallbackText = document.getElementById('fallbackText');
                fallbackText.value = jsonString;
                fallbackText.style.display = 'block';

                alert('Enlace único generado. Comparte el enlace para que otros vean el resumen directamente.');
            } catch (error) {
                alert('Error al generar enlace: ' + error.message + '. Usando fallback.');
                // Fallback a descarga
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'resumen_shein.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                document.getElementById('shareLink').innerHTML = 'No se pudo generar enlace. Copia el texto de abajo o envía el archivo descargado.';
            }
        }

        // Viewer mode
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const viewUrl = urlParams.get('view');
            if (viewUrl) {
                document.getElementById('uploaderSection').style.display = 'none';
                document.getElementById('viewerSection').style.display = 'block';
                loadViewer(viewUrl);
            }
        });

        async function loadViewer(pasteUrl) {
            try {
                const response = await fetch(pasteUrl);
                if (!response.ok) {
                    throw new Error('No se pudo cargar el resumen');
                }

                const jsonData = await response.json();
                viewerData = jsonData.data || [];
                viewerFamilies = new Set(jsonData.families || []);

                const familyFilter = document.getElementById('viewerFamilyFilter');
                familyFilter.innerHTML = '<option value="all">Todas las familias</option>';
                viewerFamilies.forEach(family => {
                    const option = document.createElement('option');
                    option.value = family;
                    option.textContent = family;
                    familyFilter.appendChild(option);
                });
                familyFilter.disabled = false;
                familyFilter.onchange = viewerFilterByFamily;

                viewerFilteredData = viewerData;
                viewerCurrentIndex = 0;
                viewerUpdateImage();
            } catch (error) {
                alert('Error al cargar el resumen: ' + error.message);
            }
        }

        function viewerFilterByFamily() {
            const familyFilter = document.getElementById('viewerFamilyFilter').value;
            viewerFilteredData = familyFilter === 'all' ? viewerData : viewerData.filter(row => row[2] === familyFilter);
            viewerCurrentIndex = 0;
            viewerUpdateImage();
        }

        function viewerUpdateImage() {
            const prevButton = document.getElementById('viewerPrevButton');
            const nextButton = document.getElementById('viewerNextButton');

            if (viewerFilteredData.length === 0) {
                document.getElementById('viewerImage').src = '';
                document.getElementById('viewerCount').textContent = '';
                document.getElementById('viewerTotals').textContent = '';
                prevButton.disabled = true;
                nextButton.disabled = true;
                return;
            }

            const image = document.getElementById('viewerImage');
            const count = document.getElementById('viewerCount');
            const totals = document.getElementById('viewerTotals');
            image.src = viewerFilteredData[viewerCurrentIndex][0];
            count.textContent = `Artículo ${viewerCurrentIndex + 1} de ${viewerFilteredData.length} - Cantidad: ${viewerFilteredData[viewerCurrentIndex][1]} - Familia: ${viewerFilteredData[viewerCurrentIndex][2]}`;
            const totalModel = viewerFilteredData[viewerCurrentIndex][1];
            const totalFamily = viewerFilteredData.reduce((sum, row) => sum + Number(row[1]), 0);
            totals.textContent = `Total del modelo: ${totalModel} - Total de ${viewerFilteredData[viewerCurrentIndex][2]}: ${totalFamily}`;
            prevButton.disabled = viewerCurrentIndex === 0;
            nextButton.disabled = viewerCurrentIndex === viewerFilteredData.length - 1;
        }

        function viewerNextImage() {
            if (viewerCurrentIndex < viewerFilteredData.length - 1) {
                viewerCurrentIndex++;
                viewerUpdateImage();
            }
        }

        function viewerPrevImage() {
            if (viewerCurrentIndex > 0) {
                viewerCurrentIndex--;
                viewerUpdateImage();
            }
        }
    </script>
</body>
</html>